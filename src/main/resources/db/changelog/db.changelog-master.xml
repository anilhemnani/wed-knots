<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- 1. role_tbl (Role.id is not auto-generated in the entity) -->
    <changeSet id="1-create-role-table" author="auto">
        <createTable tableName="role_tbl">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- 2. app_user_tbl (User.id is not auto-generated in the entity) -->
    <changeSet id="2-create-app-user-table" author="auto">
        <createTable tableName="app_user_tbl">
            <column name="id" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(255)"/>
            <column name="password" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="provider" type="VARCHAR(255)"/>
            <column name="role" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- 3. user_roles_tbl -->
    <changeSet id="3-create-user-roles-table" author="auto">
        <createTable tableName="user_roles_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT"/>
            <column name="role_id" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="user_roles_tbl" baseColumnNames="user_id"
                                  referencedTableName="app_user_tbl" referencedColumnNames="id"
                                  constraintName="fk_userroles_user" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="user_roles_tbl" baseColumnNames="role_id"
                                  referencedTableName="role_tbl" referencedColumnNames="id"
                                  constraintName="fk_userroles_role" onDelete="CASCADE"/>
    </changeSet>

    <!-- 4. wedding_event_tbl -->
    <changeSet id="4-create-wedding-event-table" author="auto">
        <createTable tableName="wedding_event_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <!-- now using DATE for LocalDate -->
            <column name="date" type="DATE"/>
            <column name="status" type="VARCHAR(255)"/>
            <column name="bride_name" type="VARCHAR(255)"/>
            <column name="groom_name" type="VARCHAR(255)"/>
            <column name="subdomain" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="expected_guest_arrival_date" type="DATE"/>
            <column name="expected_guest_departure_date" type="DATE"/>
            <column name="preferred_travel_airport" type="VARCHAR(255)"/>
            <column name="preferred_travel_station" type="VARCHAR(255)"/>
            <column name="preferred_expected_attendees" type="INT"/>
            <column name="place" type="VARCHAR(255)"/>
            <column name="expected_max_attendees" type="INT"/>
            <column name="expected_attendees" type="INT"/>
            <column name="whatsapp_api_enabled" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="whatsapp_phone_number_id" type="VARCHAR(255)"/>
            <column name="whatsapp_business_account_id" type="VARCHAR(255)"/>
            <column name="whatsapp_access_token" type="VARCHAR(512)"/>
            <column name="whatsapp_api_version" type="VARCHAR(50)" defaultValue="v24.0"/>
            <column name="whatsapp_verify_token" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <!-- 5. host_tbl -->
    <changeSet id="5-create-host-table" author="auto">
        <createTable tableName="host_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(255)"/>
            <column name="password" type="VARCHAR(255)"/>
            <column name="email" type="VARCHAR(255)"/>
            <column name="phone" type="VARCHAR(50)"/>
            <column name="provider" type="VARCHAR(255)"/>
            <column name="role" type="VARCHAR(255)"/>
            <column name="event_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="host_tbl" baseColumnNames="event_id"
                                  referencedTableName="wedding_event_tbl" referencedColumnNames="id"
                                  constraintName="fk_host_event" onDelete="CASCADE"/>
    </changeSet>

    <!-- 6. guest_tbl -->
    <changeSet id="6-create-guest-table" author="auto">
        <createTable tableName="guest_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="family_name" type="VARCHAR(255)"/>
            <column name="contact_name" type="VARCHAR(255)"/>
            <column name="contact_email" type="VARCHAR(255)"/>
            <column name="contact_phone" type="VARCHAR(50)"/>
            <column name="side" type="VARCHAR(255)"/>
            <column name="address" type="VARCHAR(1024)"/>
            <column name="max_attendees" type="INT"/>
            <column name="expected_arrival_date" type="DATE"/>
            <column name="expected_departure_date" type="DATE"/>
            <!-- ExpectedAttendance now stored as STRING -->
            <column name="expected_attendance" type="VARCHAR(50)"/>
            <column name="event_id" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="guest_tbl" baseColumnNames="event_id"
                                  referencedTableName="wedding_event_tbl" referencedColumnNames="id"
                                  constraintName="fk_guest_event" onDelete="CASCADE"/>
        <!-- Unique constraint: contact_email per event -->
        <addUniqueConstraint tableName="guest_tbl" columnNames="contact_email, event_id" constraintName="uk_guest_contact_email_event"/>
    </changeSet>

    <!-- 7. rsvp_tbl -->
    <changeSet id="7-create-rsvp-table" author="auto">
        <createTable tableName="rsvp_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="guest_id" type="BIGINT">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="event_id" type="BIGINT"/>
            <column name="status" type="VARCHAR(50)" defaultValue="Pending"/>
            <column name="attendee_count" type="INT" defaultValueNumeric="0"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="rsvp_tbl" baseColumnNames="guest_id"
                                  referencedTableName="guest_tbl" referencedColumnNames="id"
                                  constraintName="fk_rsvp_guest" onDelete="CASCADE"/>
    </changeSet>

    <!-- 8. attendee_tbl -->
    <changeSet id="8-create-attendee-table" author="auto">
        <createTable tableName="attendee_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="mobile_number" type="VARCHAR(50)"/>
            <column name="age_group" type="VARCHAR(50)"/>
            <column name="rsvp_id" type="BIGINT"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="attendee_tbl" baseColumnNames="rsvp_id"
                                  referencedTableName="rsvp_tbl" referencedColumnNames="id"
                                  constraintName="fk_attendee_rsvp" onDelete="CASCADE"/>
    </changeSet>

    <!-- 9. travel_info_tbl -->
    <changeSet id="9-create-travel-info-table" author="auto">
        <createTable tableName="travel_info_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="guest_id" type="BIGINT">
                <constraints unique="true" nullable="false"/>
            </column>
            <!-- ModeOfTravel now stored as STRING -->
            <column name="arrival_mode" type="VARCHAR(50)"/>
            <column name="arrival_date_time" type="TIMESTAMP"/>
            <column name="arrival_flight_number" type="VARCHAR(255)"/>
            <column name="arrival_train_number" type="VARCHAR(255)"/>
            <column name="arrival_airport" type="VARCHAR(255)"/>
            <column name="arrival_station" type="VARCHAR(255)"/>
            <column name="arrival_pnr_number" type="VARCHAR(255)"/>
            <column name="arrival_port" type="VARCHAR(255)"/>
            <!-- ModeOfTravel now stored as STRING -->
            <column name="departure_mode" type="VARCHAR(50)"/>
            <column name="departure_date_time" type="TIMESTAMP"/>
            <column name="departure_flight_number" type="VARCHAR(255)"/>
            <column name="departure_train_number" type="VARCHAR(255)"/>
            <column name="departure_airport" type="VARCHAR(255)"/>
            <column name="departure_station" type="VARCHAR(255)"/>
            <column name="departure_pnr_number" type="VARCHAR(255)"/>
            <column name="departure_port" type="VARCHAR(255)"/>
            <column name="needs_pickup" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="needs_drop" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="special_requirements" type="VARCHAR(1000)"/>
            <column name="notes" type="VARCHAR(1000)"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="travel_info_tbl" baseColumnNames="guest_id"
                                  referencedTableName="guest_tbl" referencedColumnNames="id"
                                  constraintName="fk_travel_info_guest" onDelete="CASCADE"/>
    </changeSet>

    <!-- 10. invitation_tbl -->
    <changeSet id="10-create-invitation-table" author="auto">
        <createTable tableName="invitation_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="event_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="message" type="TEXT"/>
            <column name="invitation_type" type="VARCHAR(255)"/>
            <column name="image_url" type="VARCHAR(1024)"/>
            <column name="message_type" type="VARCHAR(50)" defaultValue="TEMPLATE"/>
            <column name="template_name" type="VARCHAR(255)"/>
            <column name="template_language" type="VARCHAR(20)" defaultValue="en_US"/>
            <column name="created_at" type="TIMESTAMP"/>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="status" type="VARCHAR(50)" defaultValue="DRAFT"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="invitation_tbl" baseColumnNames="event_id"
                                  referencedTableName="wedding_event_tbl" referencedColumnNames="id"
                                  constraintName="fk_invitation_event" onDelete="CASCADE"/>
    </changeSet>

    <!-- 11. invitation_log_tbl -->
    <changeSet id="11-create-invitation-log-table" author="auto">
        <createTable tableName="invitation_log_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="invitation_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="guest_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="sent_at" type="TIMESTAMP"/>
            <column name="sent_by" type="VARCHAR(255)"/>
            <column name="delivery_status" type="VARCHAR(50)" defaultValue="PENDING"/>
            <column name="whatsapp_number" type="VARCHAR(255)"/>
            <column name="error_message" type="VARCHAR(1000)"/>
            <column name="delivery_timestamp" type="TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="invitation_log_tbl" baseColumnNames="invitation_id"
                                  referencedTableName="invitation_tbl" referencedColumnNames="id"
                                  constraintName="fk_invlog_invitation" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="invitation_log_tbl" baseColumnNames="guest_id"
                                  referencedTableName="guest_tbl" referencedColumnNames="id"
                                  constraintName="fk_invlog_guest" onDelete="CASCADE"/>
    </changeSet>

    <!-- 12. guest_message_tbl -->
    <changeSet id="12-create-guest-message-table" author="auto">
        <createTable tableName="guest_message_tbl">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="event_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="guest_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="guest_phone_number" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="message_content" type="TEXT"/>
            <!-- these enums are annotated with EnumType.STRING in the entity -->
            <column name="direction" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="message_type" type="VARCHAR(50)" defaultValue="TEXT"/>
            <column name="media_url" type="TEXT"/>
            <column name="is_read" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="whatsapp_message_id" type="VARCHAR(255)"/>
            <column name="status" type="VARCHAR(50)" defaultValue="PENDING"/>
            <column name="error_message" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
            <column name="read_at" type="TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="guest_message_tbl" baseColumnNames="event_id"
                                  referencedTableName="wedding_event_tbl" referencedColumnNames="id"
                                  constraintName="fk_guest_message_event"/>
        <addForeignKeyConstraint baseTableName="guest_message_tbl" baseColumnNames="guest_id"
                                  referencedTableName="guest_tbl" referencedColumnNames="id"
                                  constraintName="fk_guest_message_guest"/>

        <createIndex indexName="idx_event_is_read" tableName="guest_message_tbl">
            <column name="event_id"/>
            <column name="is_read"/>
        </createIndex>
        <createIndex indexName="idx_guest_event" tableName="guest_message_tbl">
            <column name="guest_id"/>
            <column name="event_id"/>
        </createIndex>
        <createIndex indexName="idx_timestamp" tableName="guest_message_tbl">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- 13. Seed data (roles, users, user_roles, sample event, hosts, guests, rsvps) -->
    <changeSet id="13-insert-initial-data" author="auto">
        <!-- Roles with explicit IDs (references needed) -->
        <insert tableName="role_tbl">
            <column name="id" valueNumeric="1"/>
            <column name="name" value="ROLE_ADMIN"/>
        </insert>
        <insert tableName="role_tbl">
            <column name="id" valueNumeric="2"/>
            <column name="name" value="ROLE_HOST"/>
        </insert>
        <insert tableName="role_tbl">
            <column name="id" valueNumeric="3"/>
            <column name="name" value="ROLE_GUEST"/>
        </insert>

        <!-- Admin user with explicit ID for initial seeding -->
        <insert tableName="app_user_tbl">
            <column name="id" valueNumeric="1"/>
            <column name="username" value="admin"/>
            <column name="password" value=""/>
            <column name="email" value="admin@wed-knots.uk"/>
            <column name="provider" value="local"/>
            <column name="role" value="ROLE_ADMIN"/>
        </insert>

        <insert tableName="user_roles_tbl">
            <column name="user_id" valueNumeric="1"/>
            <column name="role_id" valueNumeric="1"/>
        </insert>

        <!-- Wedding event with explicit ID -->
        <insert tableName="wedding_event_tbl">
            <column name="id" valueNumeric="1"/>
            <column name="name" value="WedKnots - Pratibha &amp; Karthik"/>
            <column name="date" valueDate="2026-06-12"/>
            <column name="status" value="Published"/>
            <column name="bride_name" value="Pratibha"/>
            <column name="groom_name" value="Karthik"/>
            <column name="subdomain" value="pratibha-karthik"/>
            <column name="expected_guest_arrival_date" valueDate="2026-06-11"/>
            <column name="expected_guest_departure_date" valueDate="2026-06-13"/>
            <column name="preferred_travel_airport" value="Mangaluru"/>
            <column name="preferred_travel_station" value="Somwhere"/>
            <column name="whatsapp_api_enabled" valueBoolean="true"/>
            <column name="whatsapp_phone_number_id" value="889286674274022"/>
            <column name="whatsapp_business_account_id" value="1569365317617857"/>
            <column name="whatsapp_access_token" value="EAAhsfeFINq4BQeoW8mr3Fl1dzVcpsWUZBVkcy4c8XDNqChgaKZAV4G9YsZC4lGmxkDYZBqFtf96KB1agIFOdCBXLD97UZAmQhx6UFceLK14ujeVljCG1hSaLOn42i6sXl9oewFfPMkjVywGpBELwYnvAqOiqrMRcB6wN6RlIDddoCTfhJD4yIGAVPDHJo1GhJMgZDZD"/>
            <column name="whatsapp_api_version" value="v24.0"/>
            <column name="whatsapp_verify_token" value="wedknots_whatsapp_verify_token"/>
        </insert>

        <!-- Host with explicit ID -->
        <insert tableName="host_tbl">
            <column name="id" valueNumeric="1"/>
            <column name="username" value="host1"/>
            <column name="password" value=""/>
            <column name="email" value="host1@example.com"/>
            <column name="phone" value="+447878597720"/>
            <column name="provider" value="local"/>
            <column name="role" value="ROLE_HOST"/>
            <column name="event_id" valueNumeric="1"/>
        </insert>

        <!-- Clean up guest and RSVP data before inserting seed data -->
        <delete tableName="rsvp_tbl">
            <where>guest_id = 1</where>
        </delete>
        <delete tableName="guest_tbl">
            <where>id = 1</where>
        </delete>

        <!-- Guest with explicit ID for seed data -->
        <insert tableName="guest_tbl">
            <column name="id" valueNumeric="1"/>
            <column name="family_name" value="Sharma"/>
            <column name="contact_name" value="Ravi Sharma"/>
            <column name="contact_email" value="ravi.sharma@example.com"/>
            <column name="contact_phone" value="+447878597720"/>
            <column name="side" value="Bride"/>
            <column name="address" value="Delhi"/>
            <column name="max_attendees" valueNumeric="5"/>
            <column name="expected_arrival_date" valueDate="2026-12-11"/>
            <column name="expected_departure_date" valueDate="2026-12-13"/>
            <column name="event_id" valueNumeric="1"/>
            <column name="expected_attendance" value="YES"/>
        </insert>

        <!-- RSVP for seed guest -->
        <insert tableName="rsvp_tbl">
            <column name="guest_id" valueNumeric="1"/>
            <column name="event_id" valueNumeric="1"/>
            <column name="status" value="PENDING"/>
            <column name="attendee_count" valueNumeric="0"/>
        </insert>

        <!-- Reset auto-increment sequences for H2 to start from 2 for new records -->
        <!-- This ensures new guests get IDs starting from 2, not conflicting with seed ID 1 -->
        <sql dbms="h2">
            ALTER TABLE guest_tbl ALTER COLUMN id RESTART WITH 2;
            ALTER TABLE host_tbl ALTER COLUMN id RESTART WITH 2;
            ALTER TABLE app_user_tbl ALTER COLUMN id RESTART WITH 2;
            ALTER TABLE rsvp_tbl ALTER COLUMN id RESTART WITH 2;
        </sql>

<!--
        &lt;!&ndash; For PostgreSQL compatibility (if used) &ndash;&gt;
        <sql dbms="postgresql">
            SELECT setval('guest_tbl_id_seq', 2, false);
            SELECT setval('host_tbl_id_seq', 2, false);
            SELECT setval('app_user_tbl_id_seq', 2, false);
            SELECT setval('rsvp_tbl_id_seq', 2, false);
        </sql>
-->
    </changeSet>

    <!-- Add external invitation support to invitation_log_tbl -->
    <changeSet id="external-invitations-support" author="auto">
        <addColumn tableName="invitation_log_tbl">
            <column name="invitation_method" type="VARCHAR(50)" defaultValue="WHATSAPP">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="invitation_log_tbl">
            <column name="external_method_description" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <!-- Audit columns for attendee, guest, wedding_event -->
    <changeSet id="add-audit-columns-attendee-guest-event" author="auto">
        <addColumn tableName="attendee_tbl">
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </addColumn>
        <addColumn tableName="guest_tbl">
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </addColumn>
        <addColumn tableName="wedding_event_tbl">
            <column name="created_at" type="TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP"/>
        </addColumn>
    </changeSet>

    <!-- Event traffic logging table -->
    <changeSet id="create-event-traffic-log" author="auto">
        <createTable tableName="event_traffic_log">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="event_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="path" type="VARCHAR(512)"/>
            <column name="created_at" type="TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="event_traffic_log" baseColumnNames="event_id"
                                 referencedTableName="wedding_event_tbl" referencedColumnNames="id"
                                 constraintName="fk_event_traffic_event" onDelete="CASCADE"/>
    </changeSet>

    <!-- Unauthorized access logging table -->
    <changeSet id="create-unauthorized-access-log" author="auto">
        <createTable tableName="unauthorized_access_log">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(255)"/>
            <column name="role" type="VARCHAR(255)"/>
            <column name="request_uri" type="VARCHAR(1024)"/>
            <column name="http_method" type="VARCHAR(16)"/>
            <column name="client_ip" type="VARCHAR(64)"/>
            <column name="reason" type="VARCHAR(1024)"/>
            <column name="created_at" type="TIMESTAMP"/>
        </createTable>
        <createIndex indexName="idx_unauthorized_access_created" tableName="unauthorized_access_log">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- Add unique constraint on whatsapp_phone_number_id for webhook routing -->
    <changeSet id="add-whatsapp-phone-id-unique-constraint" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="wedding_event_tbl"/>
        </preConditions>
        <addUniqueConstraint tableName="wedding_event_tbl" columnNames="whatsapp_phone_number_id"
                           constraintName="uq_whatsapp_phone_number_id"/>
        <createIndex indexName="idx_whatsapp_phone_number_id" tableName="wedding_event_tbl">
            <column name="whatsapp_phone_number_id"/>
        </createIndex>
    </changeSet>

    <!-- Add whatsapp_message_text column to invitation_log_tbl -->
    <include file="db/changelog/changelog-003-add-whatsapp-message-text.xml" relativeToChangelogFile="false"/>

    <!-- Add support for multiple phone numbers per guest -->
    <include file="db/changelog/changelog-004-add-multiple-phone-numbers.xml" relativeToChangelogFile="false"/>

    <!-- Track which phone numbers received invitations -->
    <include file="db/changelog/changelog-005-add-invitation-phone-records.xml" relativeToChangelogFile="false"/>
</databaseChangeLog>
