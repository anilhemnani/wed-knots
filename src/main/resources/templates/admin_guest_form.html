<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Guest Form</title>
    <meta charset="UTF-8">
    <th:block th:replace="~{_bootstrap_head :: head}"></th:block>
</head>
<body class="bg-light">
<th:block th:replace="~{_navbar :: adminNav}"></th:block>

<div class="container py-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" th:if="${guest.id == null}"><i class="bi bi-person-plus-fill"></i> Add New Guest</h5>
                    <h5 class="mb-0" th:if="${guest.id != null}"><i class="bi bi-pencil-fill"></i> Edit Guest</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{${guest.id == null ? '/admin/events/' + event.id + '/guests/new' : '/admin/guests/' + guest.id + '/edit'}}" method="POST">
                        <div class="mb-3">
                            <label for="familyName" class="form-label">Family Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="familyName" name="familyName" th:value="${guest.familyName}" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contactFirstName" class="form-label">Contact First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="contactFirstName" name="contactFirstName" th:value="${guest.contactFirstName}" placeholder="First name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contactLastName" class="form-label">Contact Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="contactLastName" name="contactLastName" th:value="${guest.contactLastName}" placeholder="Last name" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="contactEmail" name="contactEmail" th:value="${guest.contactEmail}">
                        </div>

                        <!-- Phone Numbers Section -->
                        <div class="card mb-4 bg-light">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-telephone-fill"></i> Phone Numbers <span class="text-danger">*</span></h5>
                            </div>
                            <div class="card-body">
                                <div id="phoneNumbersList">
                                    <div th:if="${guest.phoneNumbers != null && !guest.phoneNumbers.isEmpty()}" th:each="phone : ${guest.phoneNumbers}">
                                        <div class="phone-entry mb-3 p-3 border rounded bg-white">
                                            <div class="row align-items-center gy-2">
                                                <div class="col-md-3">
                                                    <label class="form-label">Phone Number</label>
                                                    <input type="tel" class="form-control phone-input"
                                                           th:value="${phone.phoneNumber}"
                                                           placeholder="+91 98765 43210"
                                                           pattern="^\+?[0-9\s\-\(\)]+$"
                                                           title="Include country code"
                                                           readonly>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Contact First Name</label>
                                                    <input type="text" class="form-control" th:value="${phone.contactFirstName}" readonly>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Contact Last Name</label>
                                                    <input type="text" class="form-control" th:value="${phone.contactLastName}" readonly>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Actions</label>
                                                    <div class="btn-group w-100" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                                data-bs-toggle="modal" data-bs-target="#editPhoneModal"
                                                                th:onclick="|editPhone([[${phone.id}]], '[[${phone.phoneNumber}]]', '[[${phone.contactFirstName}]]', '[[${phone.contactLastName}]]')|">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                                th:onclick="|confirmRemovePhone([[${phone.id}]], '[[${phone.phoneNumber}]]')|"
                                                                th:disabled="${guest.phoneNumbers.size() <= 1}">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- If no phones exist, show initial phone input -->
                                    <div th:if="${guest.phoneNumbers == null || guest.phoneNumbers.isEmpty()}">
                                        <div class="phone-entry mb-3 p-3 border rounded bg-white">
                                            <div class="row align-items-center">
                                                <div class="col-md-5">
                                                    <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                                                    <input type="tel" class="form-control phone-input new-phone-input"
                                                           name="newPhoneNumber"
                                                           placeholder="+91 98765 43210"
                                                           pattern="^\+?[0-9\s\-\(\)]+$"
                                                           title="Include country code"
                                                           required>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label">Type</label>
                                                    <select class="form-select phone-type new-phone-type" name="newPhoneType">
                                                        <option value="PERSONAL" selected>Personal</option>
                                                        <option value="WORK">Work</option>
                                                        <option value="OTHER">Other</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="form-check pt-4">
                                                        <input class="form-check-input" type="checkbox" checked disabled>
                                                        <label class="form-check-label">Primary</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add more phone button -->
                                <div th:if="${guest.id != null && guest.phoneNumbers != null && !guest.phoneNumbers.isEmpty()}">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="addPhoneBtn" data-bs-toggle="modal" data-bs-target="#addPhoneModal">
                                        <i class="bi bi-plus-circle"></i> Add Another Phone
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="side" class="form-label">Side <span class="text-danger">*</span></label>
                            <select class="form-select" id="side" name="side" required>
                                <option value="">-- Select Side --</option>
                                <option value="Bride" th:selected="${guest.side == 'Bride'}">Bride</option>
                                <option value="Groom" th:selected="${guest.side == 'Groom'}">Groom</option>
                                <option value="Both" th:selected="${guest.side == 'Both'}">Both</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="3" th:text="${guest.address}"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="maxAttendees" class="form-label">Max Attendees <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="maxAttendees" name="maxAttendees" th:value="${guest.maxAttendees}" min="0" required>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a th:href="@{/admin/events/{id}/guests(id=${event.id})}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Save Guest
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for adding new phone number (moved outside of main form to avoid nested forms) -->
<div class="modal fade" id="addPhoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Phone Number</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPhoneForm" method="POST"
                      th:action="@{/admin/events/{eventId}/guests/{guestId}/add-phone(eventId=${event.id}, guestId=${guest.id})}">
                    <div class="mb-3">
                        <label for="modalPhoneNumber" class="form-label">Phone Number <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="modalPhoneNumber" name="phoneNumber"
                               placeholder="+91 98765 43210"
                               pattern="^\+?[0-9\s\-\(\)]+$"
                               title="Include country code"
                               required>
                        <div class="form-text">Include country code (e.g., +91 for India, +1 for US/Canada)</div>
                    </div>
                    <div class="mb-3">
                        <label for="modalPhoneType" class="form-label">Phone Type</label>
                        <select class="form-select" id="modalPhoneType" name="phoneType">
                            <option value="PERSONAL" selected>Personal</option>
                            <option value="WORK">Work</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addPhoneForm" class="btn btn-primary">Add Phone</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing phone number -->
<div class="modal fade" id="editPhoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Phone Number</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPhoneForm" method="POST">
                    <input type="hidden" id="editPhoneId" name="phoneId">
                    <div class="mb-3">
                        <label for="editPhoneNumber" class="form-label">Phone Number <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="editPhoneNumber" name="phoneNumber"
                               placeholder="+91 98765 43210"
                               pattern="^\+?[0-9\s\-\(\)]+$"
                               title="Include country code"
                               required>
                        <div class="form-text">Include country code (e.g., +91 for India, +1 for US/Canada)</div>
                        <input type="hidden" name="phoneType" value="PERSONAL">
                    </div>
                    <div class="mb-3">
                        <label for="editContactFirstName" class="form-label">Contact First Name</label>
                        <input type="text" class="form-control" id="editContactFirstName" name="contactFirstName" placeholder="First name (optional)">
                    </div>
                    <div class="mb-3">
                        <label for="editContactLastName" class="form-label">Contact Last Name</label>
                        <input type="text" class="form-control" id="editContactLastName" name="contactLastName" placeholder="Last name (optional)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editPhoneForm" class="btn btn-primary">Update Phone</button>
            </div>
        </div>
    </div>
</div>

<!-- Form for removing phone number (hidden) -->
<form id="removePhoneForm" method="POST" style="display: none;">
    <input type="hidden" id="removePhoneId" name="phoneId">
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function editPhone(phoneId, phoneNumber, firstName, lastName) {
        document.getElementById('editPhoneId').value = phoneId;
        document.getElementById('editPhoneNumber').value = phoneNumber || '';
        document.getElementById('editContactFirstName').value = firstName || '';
        document.getElementById('editContactLastName').value = lastName || '';

        // Set form action
        const eventId = [[${event.id}]];
        const guestId = [[${guest.id}]];
        document.getElementById('editPhoneForm').action = `/admin/events/${eventId}/guests/${guestId}/edit-phone/${phoneId}`;
    }

    function confirmRemovePhone(phoneId, phoneNumber) {
        if (confirm(`Are you sure you want to remove phone number ${phoneNumber}?`)) {
            const eventId = [[${event.id}]];
            const guestId = [[${guest.id}]];
            document.getElementById('removePhoneId').value = phoneId;
            document.getElementById('removePhoneForm').action = `/admin/events/${eventId}/guests/${guestId}/remove-phone/${phoneId}`;
            document.getElementById('removePhoneForm').submit();
        }
    }
</script>
</body>
</html>

