<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Send WhatsApp RSVP Requests</title>
    <meta charset="UTF-8">
    <th:block th:replace="~{_bootstrap_head :: head}"></th:block>
    <style>
        .phone-icon {
            color: #25D366;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .sent-row {
            background-color: #e7f1ff;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-light">
<th:block th:replace="~{_navbar :: hostNav}"></th:block>

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-whatsapp phone-icon"></i> Send WhatsApp RSVP Requests</h1>
            <p class="text-muted mb-0" th:text="${event.name + ' - ' + event.brideName + ' & ' + event.groomName}"></p>
        </div>
        <div>
            <a th:href="@{/guests(eventId=${event.id})}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Guests
            </a>
        </div>
    </div>

    <!-- WhatsApp Configuration Status -->
    <div class="card shadow-sm mb-4" th:if="${!whatsappConfigured}">
        <div class="card-body bg-warning">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                <div>
                    <h5 class="mb-1">WhatsApp Not Configured</h5>
                    <p class="mb-0">Please configure WhatsApp API settings for this event before sending RSVP requests.</p>
                </div>
                <a th:href="@{/admin/events/{id}/whatsapp-config(id=${event.id})}" class="btn btn-primary ms-auto">
                    Configure Now
                </a>
            </div>
        </div>
    </div>

    <div th:if="${whatsappConfigured}">
        <!-- Bulk Actions Bar -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">
                            <span id="selected-count">0</span> guest(s) selected
                        </h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <button id="select-all-btn" class="btn btn-outline-primary btn-sm me-2">
                            <i class="bi bi-check-square"></i> Select All
                        </button>
                        <button id="deselect-all-btn" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="bi bi-square"></i> Deselect All
                        </button>
                        <button id="send-bulk-btn" class="btn btn-success" disabled>
                            <i class="bi bi-whatsapp"></i> Send to Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-filter"></i> Filters</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Filter by:</label>
                        <select id="filter-select" class="form-select">
                            <option value="all">All Guests</option>
                            <option value="with-phone">With Phone Number</option>
                            <option value="without-phone">Without Phone Number</option>
                            <option value="bride">Bride's Side</option>
                            <option value="groom">Groom's Side</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Search:</label>
                        <input type="text" id="search-input" class="form-control" placeholder="Search by name...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Guests Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people-fill"></i> Guests</h5>
                <span class="badge bg-light text-dark" id="total-count" th:text="${guests.size()} + ' total'"></span>
            </div>
            <div class="card-body">
                <div th:if="${guests.isEmpty()}" class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No guests added yet.
                </div>

                <div th:if="${!guests.isEmpty()}" class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                </th>
                                <th>Family Name</th>
                                <th>Contact Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Side</th>
                                <th>Max Attendees</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="guest : ${guests}"
                                class="guest-row"
                                th:data-side="${guest.side}"
                                th:data-has-phone="${guest.contactPhone != null}"
                                th:data-name="${guest.contactName + ' ' + guest.familyName}">
                                <td>
                                    <input type="checkbox"
                                           class="form-check-input guest-checkbox"
                                           th:value="${guest.id}"
                                           th:data-phone="${guest.contactPhone}"
                                           th:disabled="${guest.contactPhone == null}">
                                </td>
                                <td th:text="${guest.familyName}"></td>
                                <td th:text="${guest.contactName}"></td>
                                <td th:text="${guest.contactEmail}"></td>
                                <td>
                                    <span th:if="${guest.contactPhone != null}"
                                          th:text="${guest.contactPhone}"
                                          th:title="${guest.phoneNumbers.size() > 1 ? 'Primary â€¢ Total: ' + guest.phoneNumbers.size() : ''}"
                                          th:class="${guest.phoneNumbers.size() > 1 ? 'cursor-help' : ''}"></span>
                                    <span th:if="${guest.contactPhone == null}" class="text-muted">-</span>
                                    <span th:if="${guest.phoneNumbers.size() > 1}"
                                          class="badge bg-info status-badge ms-1"
                                          th:text="'+' + ${guest.phoneNumbers.size() - 1} + ' more'"></span>
                                </td>
                                <td>
                                    <span th:if="${guest.side != null}"
                                          class="badge bg-secondary status-badge"
                                          th:text="${guest.side}"></span>
                                </td>
                                <td th:text="${guest.maxAttendees}"></td>
                                <td class="text-end">
                                    <button type="button"
                                            class="btn btn-sm btn-success send-individual-btn"
                                            th:data-guest-id="${guest.id}"
                                            th:data-guest-name="${guest.contactName}"
                                            th:disabled="${guest.contactPhone == null}"
                                            th:title="${guest.contactPhone != null ? 'Send WhatsApp RSVP' : 'No phone number'}">
                                        <i class="bi bi-whatsapp"></i> Send
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notification-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-whatsapp me-2 text-success"></i>
            <strong class="me-auto">WhatsApp RSVP</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-message">
            Message sent successfully!
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sending RSVP Requests</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-center mb-0">Preparing to send...</p>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
const eventId = /*[[${event.id}]]*/ 0;

document.addEventListener('DOMContentLoaded', function() {
    const guestCheckboxes = document.querySelectorAll('.guest-checkbox');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');
    const sendBulkBtn = document.getElementById('send-bulk-btn');
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const filterSelect = document.getElementById('filter-select');
    const searchInput = document.getElementById('search-input');
    const guestRows = document.querySelectorAll('.guest-row');

    // Update selected count
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.guest-checkbox:checked').length;
        selectedCountSpan.textContent = selectedCount;
        sendBulkBtn.disabled = selectedCount === 0;
        updateSelectAllCheckbox();
    }

    // Update select all checkbox state
    function updateSelectAllCheckbox() {
        const totalEnabled = Array.from(guestCheckboxes).filter(cb => !cb.disabled).length;
        const selectedEnabled = Array.from(guestCheckboxes).filter(cb => !cb.disabled && cb.checked).length;
        selectAllCheckbox.checked = totalEnabled > 0 && totalEnabled === selectedEnabled;
        selectAllCheckbox.indeterminate = selectedEnabled > 0 && selectedEnabled < totalEnabled;
    }

    // Guest selection handling
    guestCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
        });
    });

    // Select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        guestCheckboxes.forEach(checkbox => {
            if (!checkbox.disabled) {
                checkbox.checked = this.checked;
            }
        });
        updateSelectedCount();
    });

    // Select all button
    selectAllBtn.addEventListener('click', function() {
        guestCheckboxes.forEach(checkbox => {
            if (!checkbox.disabled) {
                checkbox.checked = true;
            }
        });
        updateSelectedCount();
    });

    // Deselect all button
    deselectAllBtn.addEventListener('click', function() {
        guestCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCount();
    });

    // Filter functionality
    function applyFilters() {
        const filterValue = filterSelect.value;
        const searchTerm = searchInput.value.toLowerCase();

        guestRows.forEach(row => {
            let show = true;

            // Apply filter
            if (filterValue === 'with-phone' && row.dataset.hasPhone === 'false') {
                show = false;
            } else if (filterValue === 'without-phone' && row.dataset.hasPhone === 'true') {
                show = false;
            } else if (filterValue === 'bride' && row.dataset.side !== 'Bride') {
                show = false;
            } else if (filterValue === 'groom' && row.dataset.side !== 'Groom') {
                show = false;
            }

            // Apply search
            if (searchTerm && !row.dataset.name.toLowerCase().includes(searchTerm)) {
                show = false;
            }

            row.style.display = show ? '' : 'none';
        });
    }

    filterSelect.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);

    // Send to individual guest
    document.querySelectorAll('.send-individual-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const guestId = this.dataset.guestId;
            const guestName = this.dataset.guestName;

            if (!confirm(`Send WhatsApp RSVP request to ${guestName}?`)) {
                return;
            }

            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';

            try {
                const response = await fetch(`/api/whatsapp/flow/trigger-rsvp/${eventId}/${guestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    showToast(`RSVP request sent to ${guestName}!`, 'success');
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Sent';
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-success');
                    this.closest('.guest-row').classList.add('sent-row');
                } else {
                    showToast(`Failed to send to ${guestName}: ${result.message}`, 'error');
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-whatsapp"></i> Send';
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Network error occurred', 'error');
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-whatsapp"></i> Send';
            }
        });
    });

    // Send bulk
    sendBulkBtn.addEventListener('click', async function() {
        const selectedCheckboxes = document.querySelectorAll('.guest-checkbox:checked');
        const guestIds = Array.from(selectedCheckboxes).map(cb => cb.value);

        if (guestIds.length === 0) return;

        if (!confirm(`Send WhatsApp RSVP requests to ${guestIds.length} guest(s)?`)) {
            return;
        }

        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressModal.show();

        try {
            progressText.textContent = `Sending to ${guestIds.length} guests...`;
            progressBar.style.width = '50%';

            const response = await fetch(`/api/whatsapp/flow/trigger-rsvp-batch/${eventId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(guestIds)
            });

            const result = await response.json();
            progressBar.style.width = '100%';

            if (response.ok) {
                progressText.textContent = `Completed! Sent: ${result.total_sent}, Failed: ${result.total_failed}`;

                setTimeout(() => {
                    progressModal.hide();

                    // Show detailed results
                    let message = `Successfully sent to ${result.total_sent} guest(s).`;
                    if (result.total_failed > 0) {
                        message += `\n\nFailed: ${result.failed.join(', ')}`;
                    }

                    showToast(message, result.total_failed > 0 ? 'warning' : 'success');

                    // Mark sent guests
                    selectedCheckboxes.forEach(cb => {
                        cb.checked = false;
                        const row = cb.closest('.guest-row');
                        row.classList.add('sent-row');
                        const sendBtn = row.querySelector('.send-individual-btn');
                        sendBtn.innerHTML = '<i class="bi bi-check-circle"></i> Sent';
                        sendBtn.classList.remove('btn-success');
                        sendBtn.classList.add('btn-outline-success');
                    });

                    updateSelectedCount();
                }, 2000);
            } else {
                progressModal.hide();
                showToast('Failed to send batch: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            progressModal.hide();
            showToast('Network error occurred', 'error');
        }
    });

    // Toast helper
    function showToast(message, type = 'success') {
        const toast = document.getElementById('notification-toast');
        const toastMessage = document.getElementById('toast-message');
        const toastInstance = new bootstrap.Toast(toast);

        toastMessage.textContent = message;
        toast.className = 'toast';

        if (type === 'error') {
            toast.classList.add('bg-danger', 'text-white');
        } else if (type === 'warning') {
            toast.classList.add('bg-warning');
        } else {
            toast.classList.add('bg-success', 'text-white');
        }

        toastInstance.show();
    }

    // Initial state
    updateSelectedCount();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

