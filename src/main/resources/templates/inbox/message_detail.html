<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Message Detail</title>
    <meta charset="UTF-8">
    <th:block th:replace="~{_bootstrap_head :: head}"></th:block>
    <style>
        .message-detail-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message-bubble {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #007bff;
        }

        .message-bubble.inbound {
            background-color: #e7f3ff;
            border-left-color: #007bff;
        }

        .message-bubble.outbound {
            background-color: #e7ffe7;
            border-left-color: #28a745;
        }

        .message-header {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .badge-group {
            margin-top: 10px;
        }

        .info-row {
            margin: 10px 0;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 150px;
        }

        .info-value {
            color: #212529;
        }

        .media-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .media-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .conversation-context {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .context-message {
            padding: 10px;
            margin: 5px 0;
            background-color: #fff;
            border-left: 3px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .context-message.highlighted {
            border-left-color: #ffc107;
            background-color: #fffbf0;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="/host/dashboard">
          <img src="/icon" height="30" class="me-2" alt="WedKnots">
          WedKnots â€“ The Smart Wedding Concierge
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/host/dashboard">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">Logout</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-chat-dots"></i> Message Detail</h1>
            <p class="text-muted mb-0" th:text="'Event: ' + ${event.name}"></p>
        </div>
        <div>
            <a th:href="@{/inbox/events/{eventId}/guests/{guestId}(eventId=${event.id}, guestId=${guest.id})}"
               class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> View Conversation
            </a>
            <a th:href="@{/inbox/events/{id}(id=${event.id})}" class="btn btn-outline-secondary">
                <i class="bi bi-inbox"></i> Back to Inbox
            </a>
        </div>
    </div>

    <!-- Error/Success Messages -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Message Detail -->
    <div class="message-detail-card">
        <div class="message-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h3 th:text="${guest.familyName}"></h3>
                    <p class="text-muted mb-2">
                        <i class="bi bi-telephone"></i>
                        <span th:text="${guest.contactPhone}"></span>
                    </p>
                </div>
                <div class="text-end">
                    <p class="text-muted mb-1">
                        <small th:text="${#dates.format(message.createdAt, 'MMM dd, yyyy HH:mm:ss')}"></small>
                    </p>
                    <span th:class="'badge ' + (${message.direction.name()} == 'INBOUND' ? 'bg-primary' : 'bg-success')">
                        <i th:if="${message.direction.name()} == 'INBOUND'" class="bi bi-arrow-down"></i>
                        <i th:if="${message.direction.name()} == 'OUTBOUND'" class="bi bi-arrow-up"></i>
                        <span th:text="${message.direction.name()}"></span>
                    </span>
                </div>
            </div>

            <div class="badge-group">
                <span class="badge bg-info" th:text="${message.messageType}"></span>
                <span th:class="'badge ' + (${message.read} ? 'bg-success' : 'bg-warning')">
                    <i th:if="${message.read}" class="bi bi-check-circle"></i>
                    <i th:if="${!message.read}" class="bi bi-exclamation-circle"></i>
                    <span th:text="${message.read} ? 'Read' : 'Unread'"></span>
                </span>
                <span th:if="${message.status}" th:class="'badge bg-secondary'" th:text="${message.status}"></span>
            </div>
        </div>

        <!-- Message Content -->
        <div class="message-bubble" th:class="'message-bubble ' + (${message.direction.name()} == 'INBOUND' ? 'inbound' : 'outbound')">
            <div style="width: 100%;">
                <div style="font-size: 1.1rem; line-height: 1.6;">
                    <span th:text="${message.messageContent}"></span>
                </div>

                <!-- Media Section -->
                <div th:if="${message.mediaUrl}" class="media-section">
                    <strong>Media Attachment:</strong>
                    <p class="text-muted">
                        <small th:text="${message.mediaUrl}"></small>
                    </p>
                    <div th:if="${message.messageType.name()} == 'IMAGE'">
                        <img th:src="${message.mediaUrl}" alt="Message media" class="media-preview">
                    </div>
                </div>

                <!-- Metadata -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <div class="info-row">
                        <span class="info-label">Message ID:</span>
                        <span class="info-value font-monospace" th:text="${message.whatsappMessageId}"></span>
                    </div>
                    <div class="info-row" th:if="${message.read}">
                        <span class="info-label">Read At:</span>
                        <span class="info-value" th:text="${#dates.format(message.readAt, 'MMM dd, yyyy HH:mm:ss')}"></span>
                    </div>
                    <div class="info-row" th:if="${message.errorMessage}">
                        <span class="info-label">Error:</span>
                        <span class="info-value text-danger" th:text="${message.errorMessage}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reply Form -->
        <div class="message-detail-card">
            <h5 class="mb-4">
                <i class="bi bi-reply"></i> Reply to <strong th:text="${guest.contactName}"></strong>
            </h5>
            <form id="replyForm" class="reply-form">
                <div class="form-group mb-3">
                    <label for="replyContent" class="form-label">Your Reply</label>
                    <textarea class="form-control" id="replyContent" name="replyContent" rows="4"
                              placeholder="Type your reply message here..." required></textarea>
                    <small class="form-text text-muted">Your message will be sent to the guest via WhatsApp if available.</small>
                </div>
                <div id="replyStatus"></div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i> Send Reply
                </button>
                <button type="reset" class="btn btn-secondary">Clear</button>
            </form>
        </div>

        <!-- Conversation Context -->
        <div th:if="${!conversation.isEmpty()}" class="conversation-context">
            <h6><i class="bi bi-chat-left-text"></i> Conversation Context (Last 5 messages)</h6>
            <div th:each="ctx : ${#lists.size(conversation) > 5 ? #lists.subList(conversation, 0, 5) : conversation}">
                <div th:class="'context-message ' + (${ctx.id} == ${message.id} ? 'highlighted' : '')">
                    <small class="text-muted">
                        <span th:text="${#dates.format(ctx.createdAt, 'HH:mm')}"></span>
                        -
                        <strong th:text="${ctx.direction.name()}"></strong>
                    </small>
                    <p class="mb-0 mt-1" th:text="${ctx.messageContent}"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card p-3 mb-4">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="toggleReadStatus()">
                <span th:if="${message.read}">
                    <i class="bi bi-envelope"></i> Mark as Unread
                </span>
                <span th:if="${!message.read}">
                    <i class="bi bi-envelope-open"></i> Mark as Read
                </span>
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="deleteMessage()">
                <i class="bi bi-trash"></i> Delete Message
            </button>
            <a th:href="@{/inbox/events/{eventId}/guests/{guestId}(eventId=${event.id}, guestId=${guest.id})}"
               class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> View Full Conversation
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const messageId = <span th:text="${message.id}"></span>;
    const eventId = <span th:text="${event.id}"></span>;
    const guestId = <span th:text="${guest.id}"></span>;

    // Handle reply form submission
    document.getElementById('replyForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const replyContent = document.getElementById('replyContent').value.trim();

        if (!replyContent) {
            showReplyStatus('Please enter a message', 'warning');
            return;
        }

        const payload = {
            eventId: eventId,
            guestId: guestId,
            messageContent: replyContent
        };

        fetch('/api/messages/send-to-guest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to send reply');
                });
            }
            return response.json();
        })
        .then(data => {
            showReplyStatus('Reply sent successfully!', 'success');
            document.getElementById('replyContent').value = '';
            // Reload to show new message
            setTimeout(() => location.reload(), 1500);
        })
        .catch(error => {
            console.error('Error sending reply:', error);
            showReplyStatus(`Failed to send reply: ${error.message}`, 'danger');
        });
    });

    function showReplyStatus(message, type) {
        const statusDiv = document.getElementById('replyStatus');
        const alertId = 'alert-' + Date.now();
        const alertHtml = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        statusDiv.innerHTML = alertHtml;

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const element = document.getElementById(alertId);
            if (element) {
                element.remove();
            }
        }, 5000);
    }

    function toggleReadStatus() {
        const endpoint = <span th:text="${message.read ? '/inbox/messages/' + message.id + '/mark-unread' : '/inbox/messages/' + message.id + '/mark-read'}"></span>;

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to update message status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating message status');
        });
    }

    function deleteMessage() {
        if (confirm('Are you sure you want to delete this message?')) {
            fetch(`/inbox/messages/${messageId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = `/inbox/events/${eventId}`;
                } else {
                    alert('Failed to delete message');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting message');
            });
        }
    }
</script>
</body>
</html>

