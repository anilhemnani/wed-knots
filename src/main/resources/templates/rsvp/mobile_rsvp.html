<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{_guest_mobile_shell :: head}"></head>
<body class="bg-light">
<th:block th:replace="~{_navbar :: guestNav}"></th:block>
<div class="container-fluid container-mobile py-3">
    <style>
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .radio-option {
            flex: 1;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0;
            font-weight: 500;
            font-size: 14px;
        }

        .radio-option input[type="radio"]:checked + label {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-submit:active {
            transform: scale(0.98);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .spinner.show {
            display: inline-block;
        }

        .error-message {
            display: none;
            background-color: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .error-message.show {
            display: block;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-hint {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .attendee-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .attendee-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .attendee-number {
            font-weight: 600;
            color: #0d6efd;
            font-size: 14px;
        }

        .btn-remove-attendee {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .attendee-card input,
        .attendee-card select {
            margin-bottom: 10px;
        }

        .attendee-card label {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .edit-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        .view-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .view-card h5 {
            margin-bottom: 15px;
            color: #333;
        }

        .view-item {
            margin-bottom: 10px;
        }

        .view-item strong {
            color: #555;
        }

        .attendee-list {
            margin-top: 10px;
        }

        .attendee-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
            }
        }

        .animate-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>

    <!-- Page Content -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">ðŸ“‹ RSVP</h5>
                <small th:text="${eventName}">Wedding Event</small>
            </div>
            <button type="button" class="btn btn-light btn-sm" onclick="goBackToDashboard()">
                <i class="bi bi-arrow-left"></i> Back
            </button>
        </div>

        <div class="card-body position-relative">
            <!-- Loading State -->
            <div id="loadingState" class="d-flex align-items-center justify-content-center" style="min-height:120px;">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="text-muted small">Loading your RSVP...</div>
                </div>
            </div>

            <div id="rsvpContent" class="d-none">
                <div class="error-message" id="errorMessage"></div>

                <!-- RSVP View Screen -->
                <div class="step" id="rsvpViewScreen">
                    <div class="view-card">
                        <button type="button" class="edit-icon" onclick="showRsvpEdit()" title="Edit RSVP">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <h5><i class="bi bi-check-circle text-success"></i> Your RSVP</h5>
                        <div class="view-item">
                            <strong>Status:</strong> <span id="viewRsvpStatus" class="badge bg-success"></span>
                        </div>
                        <div class="view-item" id="viewAttendeesSection" style="display: none;">
                            <strong>Attendees:</strong>
                            <div id="viewAttendeesList" class="attendee-list"></div>
                        </div>
                    </div>

                </div>

                <!-- RSVP Edit Screen -->
                <div class="step" id="rsvpEditScreen">
                    <div style="margin-bottom: 1rem;">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showRsvpView()">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                    </div>

                    <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 600;" id="rsvpEditTitle">Submit
                        RSVP</h3>

                    <form id="rsvpForm" method="POST" th:action="|/rsvp/event/${eventId}/submit|"
                          onsubmit="handleRsvpSubmit(event)">
                        <input type="hidden" name="guestId" id="guestId">

                        <!-- RSVP Status -->
                        <div class="form-group">
                            <label style="margin-bottom: 15px;">Will you be attending?</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="attending" name="rsvpStatus" value="attending" required>
                                    <label for="attending">
                                        <span>âœ“ Yes, I'll attend</span>
                                    </label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="notAttending" name="rsvpStatus" value="not_attending"
                                           required>
                                    <label for="notAttending">
                                        <span>âœ— Sorry, can't attend</span>
                                    </label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="maybe" name="rsvpStatus" value="maybe" required>
                                    <label for="maybe">
                                        <span>? Maybe, not sure yet</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Attendee Details -->
                        <div class="form-group" id="attendeeDetailsGroup" style="display: none;">
                            <label style="margin-bottom: 15px;">Attendee Details</label>
                            <div id="attendeesContainer"></div>
                            <button type="button" class="btn-submit" id="addAttendeeBtn" onclick="addAttendee()"
                                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-top: 10px;">
                                + Add Attendee
                            </button>
                            <div class="form-hint" style="margin-top: 10px;">Add all attendees who will be coming with
                                you
                            </div>
                            <input type="hidden" name="attendeeCount" id="attendeeCountHidden" value="0">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <span id="rsvpSpinner" class="spinner"></span>
                            <span id="submitButtonText">Submit RSVP</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const eventId = document.querySelector('[th\\:text]')?.getAttribute('th:text') || new URLSearchParams(window.location.search).get('eventId');
    let maxAttendeesAllowed = 10;
    let attendeeCount = 0;
    let hasExistingRsvp = false;
    let lastLoadedGuestData = null;

    // Initialize RSVP page
    async function initializeRsvpPage() {
        document.getElementById('loadingState').classList.remove('d-none');
        document.getElementById('rsvpContent').classList.add('d-none');

        try {
            const response = await fetch(`/rsvp/api/guests/current`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                // Log the response details for debugging
                console.error('API Response not OK:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url
                });

                try {
                    const errorData = await response.json();
                    console.error('Error response data:', errorData);
                } catch (e) {
                    console.error('Could not parse error response as JSON');
                    const errorText = await response.text();
                    console.error('Error response text:', errorText);
                }

                // If not authenticated, redirect to login
                if (response.status === 401) {
                    window.location.href = '/login/guest';
                    return;
                }
                throw new Error('Failed to fetch guest data');
            }

            const guestData = await response.json();

            console.log('API Response - Full guestData:', guestData);
            console.log('API Response - guestData.id:', guestData.id, 'Type:', typeof guestData.id);

            // Store guest info
            document.getElementById('guestId').value = guestData.id;

            if (guestData.maxAttendees) {
                maxAttendeesAllowed = guestData.maxAttendees;
            }

            // Check if RSVP exists
            hasExistingRsvp = guestData.rsvpStatus ? true : false;

            if (hasExistingRsvp) {
                // Show RSVP view
                populateRsvpView(guestData);
                showRsvpView();
            } else {
                // Show RSVP edit form
                showRsvpEdit();
            }

            document.getElementById('rsvpContent').classList.remove('d-none');
            document.getElementById('loadingState').classList.add('d-none');

        } catch (error) {
            console.error('Error initializing:', error);
            showError('Failed to load your information. Please try again.');
            document.getElementById('rsvpContent').classList.remove('d-none');
            document.getElementById('loadingState').classList.add('d-none');
        }
    }

    // Populate RSVP view with data
    function populateRsvpView(guestData) {
        lastLoadedGuestData = guestData; // Store for edit prefill
        const statusBadge = document.getElementById('viewRsvpStatus');
        const status = (guestData.rsvpStatus || '').toLowerCase();
        const rsvp = guestData.rsvp || {};
        // Use status from RSVP object if present
        const rsvpStatus = (rsvp.status || status || '').toLowerCase();

        // Set RSVP status badge and attendees
        if (["attending", "maybe"].some(s => s.toLowerCase() === rsvpStatus)) {
            statusBadge.textContent = rsvpStatus.charAt(0).toUpperCase() + rsvpStatus.slice(1);
            statusBadge.className = 'badge bg-success';
            // Show attendees if present
            if (rsvp.attendees && rsvp.attendees.length > 0) {
                document.getElementById('viewAttendeesSection').style.display = 'block';
                const attendeeList = document.getElementById('viewAttendeesList');
                attendeeList.innerHTML = '';
                rsvp.attendees.forEach(attendee => {
                    const attendeeDiv = document.createElement('div');
                    attendeeDiv.className = 'attendee-item';
                    attendeeDiv.innerHTML = `
                        <strong>${attendee.name}</strong><br>
                        <small>ðŸ“± ${attendee.mobileNumber || 'Not provided'} | ðŸ‘¤ ${attendee.ageGroup}</small>
                    `;
                    attendeeList.appendChild(attendeeDiv);
                });
            } else {
                document.getElementById('viewAttendeesSection').style.display = 'none';
            }
        } else if (["not_attending", "declined"].some(s => s.toLowerCase() === rsvpStatus)) {
            statusBadge.textContent = 'Not Attending';
            statusBadge.className = 'badge bg-danger';
            document.getElementById('viewAttendeesSection').style.display = 'none';
        } else {
            // Pending or unknown
            statusBadge.textContent = 'Pending';
            statusBadge.className = 'badge bg-secondary';
            document.getElementById('viewAttendeesSection').style.display = 'none';
        }

    }

    // Navigation functions
    function showRsvpView() {
        document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
        document.getElementById('rsvpViewScreen').classList.add('active');
    }

    function showRsvpEdit() {
        // Use last loaded guest data for prefill
        const guestData = lastLoadedGuestData || {};
        const rsvp = guestData.rsvp || {};
        const savedStatus = (rsvp.status || guestData.rsvpStatus || '').toLowerCase();
        // Clear attendee container
        document.getElementById('attendeesContainer').innerHTML = '';
        attendeeCount = 0;
        updateAttendeeCount();
        updateAddAttendeeButton();

        // Set radio button for RSVP status
        document.querySelectorAll('input[name="rsvpStatus"]').forEach(radio => {
            radio.checked = (radio.value.toLowerCase() === savedStatus);
        });

        // Show attendee details if status is attending or maybe
        if (["pending", "attending", "maybe"].includes(savedStatus)) {
            document.getElementById('attendeeDetailsGroup').style.display = 'block';
            if (rsvp.attendees && rsvp.attendees.length > 0) {
                rsvp.attendees.forEach(att => addAttendee(att));
            }
        } else {
            document.getElementById('attendeeDetailsGroup').style.display = 'none';
        }

        document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
        document.getElementById('rsvpEditScreen').classList.add('active');
        document.getElementById('rsvpEditTitle').textContent = hasExistingRsvp ? 'Edit RSVP' : 'Submit RSVP';
        document.getElementById('submitButtonText').textContent = hasExistingRsvp ? 'Update RSVP' : 'Submit RSVP';
    }

    function goBackToDashboard() {
        window.location.href = '/guest/dashboard';
    }

    // RSVP status handling
    function handleRsvpStatus(rsvpStatus, rsvpData) {
        // Normalize status to lower case for comparison
        const status = (rsvpStatus || '').toLowerCase();
        // Hide all RSVP sections by default
        document.getElementById('attendeeSection').style.display = 'none';
        document.getElementById('notAttendingSection').style.display = 'none';
        document.getElementById('pendingSection').style.display = 'none';

        if (status === 'pending' || !status) {
            // RSVP not submitted previously
            document.getElementById('pendingSection').style.display = 'block';
        } else if (status === 'not_attending' || status === 'declined') {
            // Not attending: remove all attendees
            clearAttendees();
            document.getElementById('notAttendingSection').style.display = 'block';
        } else if (status === 'attending' || status === 'accepted' || status === 'maybe') {
            // Attending or maybe: show attendees
            document.getElementById('attendeeSection').style.display = 'block';
            if (rsvpData && rsvpData.attendees) {
                populateAttendees(rsvpData.attendees);
            }
        } else {
            // Unknown status: treat as pending
            document.getElementById('pendingSection').style.display = 'block';
        }
    }

    // RSVP form handling
    async function handleRsvpSubmit(event) {
        event.preventDefault();
        const spinner = document.getElementById('rsvpSpinner');

        try {
            spinner.classList.add('show');

            const rsvpStatus = document.querySelector('input[name="rsvpStatus"]:checked')?.value;
            const guestId = document.getElementById('guestId').value;

            console.log('RSVP Submit - Guest ID:', guestId, 'Type:', typeof guestId);
            console.log('RSVP Submit - Guest ID element exists:', !!document.getElementById('guestId'));
            console.log('RSVP Submit - Guest ID element value:', document.getElementById('guestId')?.value);

            // Validate guestId
            if (!guestId || guestId === 'undefined' || guestId === '') {
                console.error('RSVP Submit - Invalid guestId:', guestId);
                showError('Guest ID is missing. Please refresh the page and try again.');
                return;
            }

            // Ensure guestId is a number
            const guestIdNum = parseInt(guestId, 10);
            if (isNaN(guestIdNum)) {
                console.error('RSVP Submit - guestId is not a number:', guestId);
                showError('Invalid guest ID. Please refresh the page and try again.');
                return;
            }

            let attendees = [];
            if (rsvpStatus && rsvpStatus.toLowerCase() === 'attending') {
                const attendeeCards = document.querySelectorAll('.attendee-card');
                attendeeCards.forEach(card => {
                    const name = card.querySelector('input[name="attendeeName"]').value;
                    const mobileNumber = card.querySelector('input[name="attendeeMobile"]').value;
                    const ageGroup = card.querySelector('select[name="attendeeAgeGroup"]').value;
                    attendees.push({ name, mobileNumber, ageGroup });
                });
            }

            const requestData = {
                guestId, rsvpStatus, attendees, attendeeCount: attendees.length
            };

            console.log('RSVP Submit - Request Data:', requestData);
            console.log('RSVP Submit - Event ID:', getEventId());
            console.log('RSVP Submit - Submit URL:', `/rsvp/event/${getEventId()}/submit`);

            const response = await fetch(`/rsvp/event/${getEventId()}/submit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            console.log('RSVP Submit - Response Status:', response.status);
            console.log('RSVP Submit - Response OK:', response.ok);

            if (response.ok) {
                const result = await response.json();
                console.log('RSVP Submit - Success Response:', result);
                // Refresh guest data and show view
                await refreshGuestData();
                showRsvpView();

            } else {
                console.error('RSVP Submit - Response not OK');
                try {
                    const errorData = await response.json();
                    console.error('RSVP Submit - Error Response Data:', errorData);
                    showError(errorData.error || 'Failed to submit RSVP. Please try again.');
                } catch (e) {
                    console.error('RSVP Submit - Could not parse error response');
                    const errorText = await response.text();
                    console.error('RSVP Submit - Error Response Text:', errorText);
                    showError('Failed to submit RSVP. Please try again.');
                }
            }

        } catch (error) {
            console.error('RSVP Submit - Exception:', error);
            showError('An error occurred. Please try again.');
        } finally {
            spinner.classList.remove('show');
        }
    }


    // Refresh guest data after updates
    async function refreshGuestData() {
        try {
            const response = await fetch(`/rsvp/api/guests/current`, {
                method: 'GET', headers: { 'Content-Type': 'application/json' }
            });
            if (response.ok) {
                const guestData = await response.json();
                hasExistingRsvp = guestData.rsvpStatus ? true : false;
                populateRsvpView(guestData);
            }
        } catch (error) {
            console.error('Error refreshing data:', error);
        }
    }

    // Attendee management functions
    function addAttendee(attendeeData = null) {
        if (attendeeCount >= maxAttendeesAllowed) {
            showError('Maximum number of attendees reached for your invitation.');
            updateAddAttendeeButton();
            return;
        }

        attendeeCount++;
        const container = document.getElementById('attendeesContainer');
        const attendeeCard = document.createElement('div');
        attendeeCard.className = 'attendee-card';
        attendeeCard.setAttribute('data-attendee-index', attendeeCount - 1);

        attendeeCard.innerHTML = `
            <div class="attendee-card-header">
                <span class="attendee-number">Attendee ${attendeeCount}</span>
                <button type="button" class="btn-remove-attendee" onclick="removeAttendee(this)">Remove</button>
            </div>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" name="attendeeName" class="form-control"
                       value="${attendeeData ? attendeeData.name : ''}" required>
            </div>
            <div class="form-group">
                <label>Mobile Number</label>
                <input type="tel" name="attendeeMobile" class="form-control"
                       value="${attendeeData ? attendeeData.mobile : ''}" placeholder="+44 1234 567890">
            </div>
            <div class="form-group">
                <label>Age Group</label>
                <select name="attendeeAgeGroup" class="form-control" required>
                    <option value="Adult" ${attendeeData && attendeeData.ageGroup === 'Adult' ? 'selected' : ''}>Adult</option>
                    <option value="Child" ${attendeeData && attendeeData.ageGroup === 'Child' ? 'selected' : ''}>Child (6-12)</option>
                    <option value="Infant" ${attendeeData && attendeeData.ageGroup === 'Infant' ? 'selected' : ''}>Infant (0-5)</option>
                </select>
            </div>
        `;
        container.appendChild(attendeeCard);

        updateAttendeeCount();
        updateAddAttendeeButton();
    }

    function removeAttendee(button) {
        const card = button.closest('.attendee-card');
        card.remove();
        attendeeCount--;
        renumberAttendees();
        updateAttendeeCount();
        updateAddAttendeeButton();
    }

    function renumberAttendees() {
        const cards = document.querySelectorAll('.attendee-card');
        cards.forEach((card, index) => {
            card.setAttribute('data-attendee-index', index);
            const numberSpan = card.querySelector('.attendee-number');
            numberSpan.textContent = `Attendee ${index + 1}`;
        });
    }

    function updateAttendeeCount() {
        document.getElementById('attendeeCountHidden').value = attendeeCount;
    }

    function updateAddAttendeeButton() {
        const addBtn = document.getElementById('addAttendeeBtn');
        if (!addBtn) return;

        if (attendeeCount >= maxAttendeesAllowed) {
            addBtn.style.display = 'none';
        } else {
            addBtn.style.display = 'inline-block'; // Use inline-block for button
        }
    }

    // Show/hide Add Attendee button based on RSVP status and pending state
    function updateAttendeeButtonVisibility() {
        const rsvpStatus = document.querySelector('input[name="rsvpStatus"]:checked');
        const addAttendeeBtn = document.getElementById('addAttendeeBtn');
        let isPending = true;
        if (typeof lastLoadedGuestData === 'object' && lastLoadedGuestData !== null) {
            const status = (lastLoadedGuestData.rsvpStatus || '').toLowerCase();
            const rsvp = lastLoadedGuestData.rsvp || {};
            const savedStatus = (rsvp.status || status || '').toLowerCase();
            isPending = !savedStatus || savedStatus === 'pending';
        }
        if (!rsvpStatus || rsvpStatus.value.toLowerCase() === 'not_attending') {
            addAttendeeBtn.style.display = 'none';
        } else if (
            (rsvpStatus.value.toLowerCase() === 'attending' || rsvpStatus.value.toLowerCase() === 'maybe') &&
            (isPending || !hasExistingRsvp)
        ) {
            addAttendeeBtn.style.display = 'inline-block'; // Use inline-block for button
        } else {
            addAttendeeBtn.style.display = 'none';
        }
    }

    // Attach event listeners to RSVP radio buttons
    //const rsvpRadios = document.querySelectorAll('input[name="rsvpStatus"]');
    //rsvpRadios.forEach(radio => {
      //  radio.addEventListener('change', updateAttendeeButtonVisibility);
    //});

    // Initial call to set button visibility on page load
//        updateAttendeeButtonVisibility();

    // Event listeners
    document.querySelectorAll('input[name="rsvpStatus"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const val = this.value.toLowerCase();
            const show = (val === 'attending' || val === 'maybe');
            document.getElementById('attendeeDetailsGroup').style.display = show ? 'block' : 'none';
            updateAttendeeButtonVisibility();
            updateAddAttendeeButton();
        });
    });

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.innerText = message;
        errorDiv.classList.add('show');
        setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

    function getEventId() {
        const pathArray = window.location.pathname.split('/');
        return pathArray[pathArray.length - 1];
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeRsvpPage();
    });
</script>
</body>
</html>



