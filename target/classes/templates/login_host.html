<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Host Login</title>
    <meta charset="UTF-8">
    <th:block th:replace="~{_bootstrap_head :: head}"></th:block>
</head>
<body class="bg-light">
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card shadow">
        <div class="card-body">
          <h2 class="mb-4 text-center">Host Login</h2>
          <div th:if="${loginError}" class="alert alert-danger" th:text="${loginError}"></div>
          <form th:action="@{/login/host}" method="post" id="loginForm">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" id="email" name="email" class="form-control" th:value="${email}" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" id="password" name="password" class="form-control" required>
              <small class="form-text text-muted">
                <i class="bi bi-info-circle"></i> First time login? Enter any password and you'll be prompted to set a new one.
              </small>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>
          <div class="mt-3 text-center">
            <a th:href="@{/login}">‚Üê Back to Login Options</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Password Setup Modal -->
<div class="modal fade" id="passwordSetupModal" tabindex="-1" aria-labelledby="passwordSetupModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="passwordSetupModalLabel">Set Your Password</h5>
      </div>
      <div class="modal-body">
        <div id="modalError" class="alert alert-danger d-none"></div>
        <form id="passwordSetupForm">
          <input type="hidden" id="modalEmail" name="email" th:value="${email}">
          <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" name="password" required minlength="6">
            <small class="form-text text-muted">Minimum 6 characters</small>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="confirmPassword" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="submitPasswordSetup()">Set Password</button>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  var firstTimeLogin = /*[[${firstTime}]]*/ false;
  var email = /*[[${email}]]*/ '';

  if (firstTimeLogin) {
    document.addEventListener('DOMContentLoaded', function() {
      var modal = new bootstrap.Modal(document.getElementById('passwordSetupModal'));
      modal.show();
      document.getElementById('modalEmail').value = email;
    });
  }

  function submitPasswordSetup() {
    var newPassword = document.getElementById('newPassword').value;
    var confirmPassword = document.getElementById('confirmPassword').value;
    var errorDiv = document.getElementById('modalError');

    if (newPassword.length < 6) {
      errorDiv.textContent = 'Password must be at least 6 characters long.';
      errorDiv.classList.remove('d-none');
      return;
    }

    if (newPassword !== confirmPassword) {
      errorDiv.textContent = 'Passwords do not match.';
      errorDiv.classList.remove('d-none');
      return;
    }

    // Submit the form
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '/set-password-host';

    var emailInput = document.createElement('input');
    emailInput.type = 'hidden';
    emailInput.name = 'email';
    emailInput.value = document.getElementById('modalEmail').value;

    var passwordInput = document.createElement('input');
    passwordInput.type = 'hidden';
    passwordInput.name = 'password';
    passwordInput.value = newPassword;

    form.appendChild(emailInput);
    form.appendChild(passwordInput);
    document.body.appendChild(form);
    form.submit();
  }
  /*]]>*/
</script>
</body>
</html>
